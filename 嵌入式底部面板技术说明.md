# 嵌入式底部面板技术说明

## 功能概述

本项目现在提供了两种底部面板解决方案：

1. **标准浮动面板** - 使用VSTO CustomTaskPane，浮动显示
2. **嵌入式底部面板** - 使用Win32 API，尝试嵌入到Outlook阅读窗格下方（实验性功能）

## 技术实现

### 嵌入式底部面板的工作原理

基于您示意图中红框位置的需求，我们实现了一个使用Win32 API的解决方案：

#### 核心技术组件

1. **Win32Helper.vb** - Win32 API封装类
   - `FindOutlookMainWindow()` - 多策略查找Outlook主窗口
   - `FindReadingPane()` - 智能查找邮件阅读窗格
   - `CreateBottomPanel()` - 创建并定位底部面板（含调试信息）

2. **EmbeddedBottomPane.vb** - 嵌入式面板控件
   - 继承自UserControl，提供自定义界面
   - `TryEmbedInOutlook()` - 尝试嵌入到Outlook（含备用方案）
   - `TryPositionNearOutlook()` - 备用定位方案
   - `IsEmbeddedInOutlook` - 检查嵌入状态

#### 实现步骤

1. **增强的窗口查找**
   - 多种策略查找Outlook主窗口：
     - 主要："rctrl_renwnd32"类名
     - 备用："OutlookGrid"、"XLMAIN"类名
     - 最后：通过窗口标题"Microsoft Outlook"
   - 智能阅读窗格识别：
     - 支持更多类名模式（"_WwG"、"_WwF"、"WordDocument"等）
     - 按窗口大小筛选，选择最大的作为主阅读区域
     - 完整的调试日志输出

2. **改进的空间调整**
   ```vb
   ' 精确的坐标转换和边界检查
   SetWindowPos(targetWindow, HWND_TOP, 
               targetRect.Left - parentRect.Left, 
               targetRect.Top - parentRect.Top, 
               targetRect.Width, 
               targetRect.Height - panelHeight, 
               SWP_NOZORDER Or SWP_NOACTIVATE)
   ```

3. **多层级嵌入策略**
   ```vb
   ' 主要方案：Win32 API真正嵌入
   SetParent(panelControl.Handle, parentWindow)
   SetWindowPos(panelControl.Handle, HWND_TOP, 
               panelX, panelY, panelWidth, panelHeight, 
               SWP_NOZORDER Or SWP_NOACTIVATE Or SWP_SHOWWINDOW)
   
   ' 备用方案：独立窗口定位到Outlook附近
   ' 自动降级，确保面板总能正常显示
   ```

## 使用方法

### 在Outlook功能区中

1. **嵌入面板** 按钮 - 显示/隐藏嵌入式底部面板
2. **底部面板** 按钮 - 显示/隐藏标准浮动面板
3. **最小化** 按钮 - 最小化/还原浮动面板

### 嵌入式面板特性

- **自动检测** - 自动查找Outlook窗口和阅读窗格
- **智能回退** - 如果嵌入失败，自动显示为独立窗口
- **状态显示** - 实时显示嵌入状态和操作结果
- **资源清理** - 卸载时自动恢复原始窗口布局

## 技术限制与说明

### 为什么需要Win32 API方案

<mcreference link="https://social.msdn.microsoft.com/Forums/office/en-US/e8ef2b55-bbe4-4f14-b5bd-5239399cb07e/outlook-2013-vsto-custom-button-in-reading-pane?forum=outlookdev" index="4">4</mcreference> <mcreference link="https://www.codeproject.com/Articles/27262/Additional-custom-panel-in-Microsoft-Outlook" index="4">4</mcreference>

1. **VSTO限制** - 标准VSTO只支持侧边栏TaskPane，无法直接在主内容区域下方创建面板
2. **Form Region限制** - Outlook Form Region不支持在阅读窗格下方的布局
3. **CustomTaskPane限制** - 只能停靠在窗口边缘，无法嵌入到内容区域

### 实验性功能说明

嵌入式底部面板是实验性功能，可能存在以下限制：

1. **兼容性** - 不同Outlook版本的窗口结构可能不同
2. **稳定性** - Win32 API操作可能影响Outlook稳定性
3. **布局适应** - 窗口大小变化时可能需要手动调整
4. **权限要求** - 某些环境可能限制Win32 API调用

### 推荐使用方式

1. **优先使用标准浮动面板** - 更稳定，兼容性更好
2. **测试环境试用嵌入式面板** - 在非生产环境测试功能
3. **根据需求选择** - 如果必须要底部位置，可尝试嵌入式方案

## 故障排除

### 调试信息

现在版本包含详细的调试输出，可在Visual Studio的输出窗口查看：

```
找到Outlook主窗口: [窗口句柄]
所有子窗口类名: [类名列表]
找到阅读窗格: [类名] ([宽度]x[高度])
目标窗口位置: ([X], [Y]) 大小: [宽度]x[高度]
父窗口位置: ([X], [Y]) 大小: [宽度]x[高度]
计算的面板位置: ([X], [Y]) 大小: [宽度]x[高度]
面板定位结果: [True/False]
```

### 常见问题及解决方案

1. **面板与邮件窗体完全分离**
   - **原因**：Win32窗口查找失败或定位计算错误
   - **解决方案**：
     - 查看调试输出确认窗口查找结果
     - 系统会自动启用备用方案，将面板显示为独立窗口
     - 独立窗口会尽量定位在Outlook窗口附近

2. **面板无法显示**
   - 检查Outlook版本兼容性
   - 确认插件已正确加载
   - 查看Visual Studio输出窗口的详细调试信息
   - 尝试使用标准"底部面板"功能

3. **面板位置不正确**
   - 查看调试输出中的窗口位置信息
   - 可能是Outlook界面布局变化导致
   - 系统会自动尝试多种定位策略
   - 最终会降级到独立窗口模式

4. **性能影响**
   - Win32 API调用可能影响性能
   - 建议在不需要时关闭嵌入式面板
   - 使用标准浮动面板作为日常使用方案

### 备用方案说明

当Win32嵌入失败时，系统会自动：
1. 尝试将面板显示为独立窗口，定位在Outlook窗口附近
2. 如果仍然失败，显示在屏幕中央
3. 确保用户始终能看到和使用面板功能

## 技术参考

- <mcreference link="https://www.codeproject.com/Articles/27262/Additional-custom-panel-in-Microsoft-Outlook" index="4">4</mcreference> CodeProject: Additional custom panel in Microsoft Outlook
- <mcreference link="https://social.msdn.microsoft.com/Forums/office/en-US/e8ef2b55-bbe4-4f14-b5bd-5239399cb07e/outlook-2013-vsto-custom-button-in-reading-pane?forum=outlookdev" index="4">4</mcreference> MSDN Forums: Outlook VSTO Custom button in reading pane
- Microsoft VSTO Documentation
- Win32 API Reference

## 更新日志

### v1.2.0 (2024-12-19)
- **重大改进**：解决面板与邮件窗体分离问题
- **增强窗口查找**：支持多种Outlook窗口类名和查找策略
- **智能阅读窗格识别**：改进窗口匹配逻辑，支持更多类名模式
- **详细调试信息**：添加完整的调试日志输出
- **多层级备用方案**：
  - 主要：Win32 API真正嵌入
  - 备用1：独立窗口定位到Outlook附近
  - 备用2：独立窗口显示在屏幕中央
- **改进坐标计算**：精确的屏幕坐标到客户区坐标转换
- **边界检查**：确保面板始终在可见范围内

### v1.1.0
- 添加嵌入式底部面板功能
- 标准浮动底部面板

### v1.0.0
- 基础邮件线程面板功能

---

**注意**: 嵌入式底部面板是实验性功能，建议在测试环境中充分验证后再在生产环境使用。